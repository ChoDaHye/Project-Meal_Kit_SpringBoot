<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mealkitspringboot.mapper.BomMapper">
    <!-- BOM 등록 -->
    <insert id="insert">

    </insert>

    <!-- 현재 스크롤 위치(무한 스크롤) -->
    <select id="readCurrval" resultType="java.lang.Integer">
        select listSeq.currval from dual
    </select>

    <!-- 전체 BOM 개수 조회(무한 스크롤에 사용) -->
    <select id="getCountByListSeq" resultType="int">
        <![CDATA[
            select count(#{listSeq}) from dual
        ]]>
    </select>

    <!-- BOM 삭제 -->
    <delete id="delete">
        DELETE
        FROM
            BOM b
        WHERE
            b.bom_id = #{bomId}
            AND b.material_id = #{matId}
    </delete>

    <!-- BOM 수정 -->
    <update id="update">
        BEGIN
            UPDATE FINISHED_PRODUCT
                SET
                    PRODUCT_DIV = #{inputProdDiv},
                    PRODUCT_SPEC = #{inputProdSpec}
                WHERE
                    PRODUCT_ID = #{prodId}

            UPDATE MATERIAL
                SET
                    MATERIAL_CLASSIFICATION = #{inputMatDiv}
                WHERE
                    MATERIAL_ID = #{matId}

            UPDATE INSTRUCTION
                SET
                    LOT_SIZE = #{inputLotSize}
                WHERE
                    LOT_ID = #{lotId}

            UPDATE BOM
                SET
                    BOM_PROD_QUANTITY = #{inputQuantity},
                    QUANTITY_UNITS = #{inputUnits}
                WHERE
                    BOM_ID = #{bomId}
                AND PRODUCT_ID = #{prodId}
                AND MATERIAL_ID = #{matId}
                AND LOT_ID = #{lotId}

            COMMIT;
        END;

    </update>

    <!-- 제품명 옵션 검색 -->
    <select id="getProdNmList" resultType="org.mealkitspringboot.domain.BomListVo">
        SELECT
            DISTINCT product_nm
        FROM
            Finished_Product
        ORDER BY
            product_nm
    </select>

    <!-- 제품 규격 옵션 검색 -->
    <select id="getProdDivList" resultType="org.mealkitspringboot.domain.BomListVo">
        SELECT
            DISTINCT product_div
        FROM
            Finished_Product
        ORDER BY
            product_div
    </select>

    <!-- 재료명 옵션 검색 -->
    <select id="getMatNmList" resultType="org.mealkitspringboot.domain.BomListVo">
        SELECT
            material_nm
        FROM
            material
        ORDER BY
            material_nm
    </select>

    <!-- BOM 현황 - 제품 목록 조회 및 검색 -->
    <select id="read" resultType="org.mealkitspringboot.domain.BomListVo">
        <![CDATA[
        SELECT
            b.BOM_ID, b.PRODUCT_ID, fp.PRODUCT_NM, fp.PRODUCT_SPEC
            , i.LOT_SIZE
            , m.MATERIAL_CLASSIFICATION, b.MATERIAL_ID, m.MATERIAL_NM
            , b.QUANTITY_UNITS, b.BOM_PROD_QUANTITY
        FROM
            BOM b, FINISHED_PRODUCT fp, MATERIAL m, INSTRUCTION i
        WHERE
            b.PRODUCT_ID = fp.PRODUCT_ID
            AND b.MATERIAL_ID = m.MATERIAL_ID
            AND b.LOT_ID = i.LOT_ID
        ]]>
        <foreach item="keywords" collection="keywordsArr">
            <if test="searchProdNm != null and searchProdNm != ''">
                AND fp.PRODUCT_NM LIKE '%' || #{searchProdNm} || '%'
            </if>
            <if test="searchProdDiv != null and searchProdDiv != ''">
                AND fp.searchProdDiv LIKE '%' || #{searchProdDiv} || '%'
            </if>
            <if test="searchMatNm != null and searchMatNm != ''">
                AND m.searchMatNm LIKE '%' || #{searchMatNm} || '%'
            </if>
        </foreach>
        ORDER BY
            b.BOM_ID, b.PRODUCT_ID, m.MATERIAL_CLASSIFICATION
    </select>

</mapper>